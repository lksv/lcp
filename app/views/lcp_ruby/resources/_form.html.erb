<% conditions_url = if service_conditions?(current_presenter)
     @record.new_record? ? lcp_ruby.evaluate_conditions_new_path(lcp_slug: current_presenter.slug) : lcp_ruby.evaluate_conditions_path(lcp_slug: current_presenter.slug, id: @record.id)
   end %>
<% form_data = {}
   form_data["lcp-conditions-url"] = conditions_url if conditions_url
   form_data["lcp-select-options-path"] = select_options_path if defined?(select_options_path)
%>
<%= form_with(model: @record, url: @record.new_record? ? resources_path : resource_path(@record), scope: :record, method: @record.new_record? ? :post : :patch, class: "lcp-form", data: form_data) do |form| %>
  <% if @record.errors.any? %>
    <div class="lcp-errors">
      <h3><%= pluralize(@record.errors.count, "error") %> prevented this record from being saved:</h3>
      <ul>
        <% @record.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <% sections = @layout_builder.form_sections %>
  <% if @layout_builder.form_layout == "tabs" %>
    <div class="lcp-tabs">
      <nav class="lcp-tab-nav">
        <% sections.each_with_index do |section, i| %>
          <% next if section["type"] == "nested_fields" && i != sections.index(section) %>
          <%
            tab_cond_attrs = conditional_data(section)
            tab_visible = section["visible_when"].is_a?(Hash) ? condition_met?(@record, section["visible_when"]) : true
          %>
          <button type="button" data-lcp-tab="<%= i %>" class="btn <%= 'active' if i == 0 %>"
                  <% if tab_cond_attrs.any? %>data-lcp-conditional="tab"<% end %>
                  <%= tag.attributes(tab_cond_attrs) %>
                  <% unless tab_visible %>style="display: none"<% end %>>
            <%= section["title"] %>
          </button>
        <% end %>
      </nav>
      <% sections.each_with_index do |section, i| %>
        <div data-lcp-panel="<%= i %>" style="<%= 'display: none' unless i == 0 %>">
          <%= render partial: "lcp_ruby/resources/form_section", locals: { form: form, section: section } %>
        </div>
      <% end %>
    </div>
  <% else %>
    <% sections.each do |section| %>
      <%= render partial: "lcp_ruby/resources/form_section", locals: { form: form, section: section } %>
    <% end %>
  <% end %>

  <div class="lcp-form-actions">
    <%= form.submit @record.new_record? ? "Create" : "Update", class: "btn btn-primary" %>
    <%= link_to "Cancel", resources_path, class: "btn" %>
  </div>
<% end %>
