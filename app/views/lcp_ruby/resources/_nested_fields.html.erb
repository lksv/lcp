<% sortable_field = section["sortable_field"] %>
<% visible_fields = (section["fields"] || []).reject { |f| sortable_field && f["field"] == sortable_field } %>
<div class="lcp-nested-row">
  <% if sortable_field %>
    <span class="lcp-drag-handle">&#9776;</span>
  <% end %>
  <div class="lcp-nested-fields" style="display: grid; grid-template-columns: repeat(<%= section['columns'] || visible_fields.size %>, 1fr); gap: 0.5rem;">
    <% visible_fields.each do |field_config| %>

      <% field_def = field_config["field_definition"] %>
      <% next unless field_def %>
      <% field_name = field_config["field"] %>

      <div class="lcp-form-field">
        <%= form.label field_name, field_def.label %>
        <% resolved_input = field_config["input_type"] || field_def.type_definition&.input_type || field_def.type %>
        <%= render_form_input(form, field_name, resolved_input, field_config, field_def) %>
      </div>
    <% end %>
  </div>

  <% if sortable_field %>
    <%= form.hidden_field sortable_field.to_sym, class: "lcp-position-field" %>
  <% end %>

  <% if section["allow_remove"] != false %>
    <%= form.hidden_field :_destroy, value: false, class: "lcp-destroy-flag" %>
    <button type="button" class="btn btn-danger lcp-nested-remove">Remove</button>
  <% end %>
</div>
