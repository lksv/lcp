<!DOCTYPE html>
<html>
<head>
  <title>LCP Ruby</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <%= csrf_meta_tags %>
  <%= stylesheet_link_tag "lcp_ruby/tom-select", media: "all" if Rails.application.config.respond_to?(:assets) %>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; color: #333; background: #f5f5f5; line-height: 1.5; }
    .lcp-container { max-width: 1200px; margin: 0 auto; padding: 1rem 2rem; }

    /* Flash messages */
    .lcp-flash { padding: 0.75rem 1rem; margin-bottom: 1rem; border-radius: 4px; }
    .lcp-flash-notice { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .lcp-flash-alert { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

    /* Header */
    .lcp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 2px solid #dee2e6; }
    .lcp-header h1 { font-size: 1.5rem; font-weight: 600; }
    .lcp-toolbar { display: flex; gap: 0.5rem; align-items: center; }

    /* Buttons */
    .btn { display: inline-block; padding: 0.4rem 0.9rem; border: 1px solid #ccc; border-radius: 4px; background: #fff; color: #333; text-decoration: none; font-size: 0.875rem; cursor: pointer; }
    .btn:hover { background: #e9ecef; }
    .btn-primary { background: #0d6efd; color: #fff; border-color: #0d6efd; }
    .btn-primary:hover { background: #0b5ed7; }
    .btn-danger, button.btn-danger { background: #dc3545; color: #fff; border-color: #dc3545; padding: 0.4rem 0.9rem; border-radius: 4px; font-size: 0.875rem; cursor: pointer; }
    .btn-danger:hover { background: #bb2d3b; }
    .btn-filter { margin-right: 0.25rem; }
    .btn-filter.active { background: #0d6efd; color: #fff; border-color: #0d6efd; }

    /* Tables */
    .lcp-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 4px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .lcp-table th, .lcp-table td { padding: 0.6rem 0.75rem; text-align: left; border-bottom: 1px solid #dee2e6; }
    .lcp-table th { background: #f8f9fa; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; color: #6c757d; }
    .lcp-table th a { color: #6c757d; text-decoration: none; }
    .lcp-table th a:hover { color: #333; }
    .lcp-table th a.lcp-sorted { color: #333; }
    .lcp-sort-icon { display: inline-block; margin-left: 0.25rem; font-size: 0.65rem; vertical-align: middle; }
    .lcp-sort-icon.lcp-sort-asc::after { content: "\25B2"; }
    .lcp-sort-icon.lcp-sort-desc::after { content: "\25BC"; }
    .lcp-table tr:hover { background: #f8f9fa; }
    .lcp-actions { white-space: nowrap; }
    .lcp-actions a { color: #0d6efd; text-decoration: none; font-size: 0.875rem; margin-right: 0.5rem; }
    .lcp-actions form { display: inline; margin-right: 0.5rem; }
    .lcp-actions form:last-child, .lcp-actions a:last-child { margin-right: 0; }
    .lcp-actions button { font-size: 0.8rem; padding: 0.2rem 0.5rem; }

    /* Badges */
    .badge { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 12px; background: #6c757d; color: #fff; font-size: 0.75rem; font-weight: 500; }

    /* Search */
    .lcp-search { margin-bottom: 1rem; }
    .lcp-search-form { display: flex; gap: 0.5rem; }
    .lcp-search-form input[type="text"] { padding: 0.4rem 0.75rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.875rem; min-width: 250px; }
    .lcp-filters { margin-bottom: 1rem; display: flex; gap: 0.25rem; }

    /* Forms */
    .lcp-form-section { border: 1px solid #dee2e6; border-radius: 4px; padding: 1rem; margin-bottom: 1rem; background: #fff; }
    .lcp-form-section legend { font-weight: 600; padding: 0 0.5rem; }
    .lcp-form-field { margin-bottom: 0.75rem; }
    .lcp-form-field label { display: block; font-weight: 500; margin-bottom: 0.25rem; font-size: 0.875rem; }
    .lcp-form-field input, .lcp-form-field textarea, .lcp-form-field select { width: 100%; padding: 0.4rem 0.75rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.875rem; }
    .lcp-form-field input[type="checkbox"] { width: auto; }
    .lcp-form-field input[type="range"] { padding: 0; }
    .lcp-form-field textarea { min-height: 80px; }
    .lcp-form-actions { margin-top: 1rem; display: flex; gap: 0.5rem; }

    /* Errors */
    .lcp-errors { background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 0.75rem 1rem; margin-bottom: 1rem; color: #721c24; }
    .lcp-errors h3 { font-size: 0.9rem; margin-bottom: 0.5rem; }
    .lcp-errors ul { margin-left: 1.25rem; font-size: 0.875rem; }

    /* Show view */
    .lcp-section { background: #fff; border: 1px solid #dee2e6; border-radius: 4px; padding: 1rem; margin-bottom: 1rem; }
    .lcp-section h2 { font-size: 1.1rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid #eee; }
    .lcp-field { margin-bottom: 0.5rem; }
    .lcp-field label { display: block; font-size: 0.75rem; text-transform: uppercase; color: #6c757d; font-weight: 600; }
    .lcp-field-value { font-size: 0.9rem; }

    /* Display types */
    .lcp-code { background: #f8f9fa; padding: 0.1em 0.4em; border-radius: 3px; font-family: monospace; font-size: 0.875em; }
    .lcp-bool-true { color: #28a745; font-weight: 500; }
    .lcp-bool-false { color: #dc3545; font-weight: 500; }
    .lcp-progress-bar { background: #e9ecef; border-radius: 4px; overflow: hidden; height: 1.25rem; }
    .lcp-progress-fill { background: #0d6efd; height: 100%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 0.7rem; font-weight: 500; min-width: 2em; transition: width 0.3s; }
    .lcp-avatar { border-radius: 50%; object-fit: cover; }
    .lcp-rating-display { color: #ffc107; font-size: 1.1em; letter-spacing: 0.1em; }

    /* Input group (prefix/suffix) */
    .lcp-input-group { display: flex; align-items: stretch; }
    .lcp-input-group input, .lcp-input-group select { flex: 1; border-radius: 0; }
    .lcp-input-prefix, .lcp-input-suffix { display: flex; align-items: center; padding: 0 0.5rem; background: #e9ecef; border: 1px solid #ccc; font-size: 0.875rem; color: #6c757d; white-space: nowrap; }
    .lcp-input-prefix { border-right: none; border-radius: 4px 0 0 4px; }
    .lcp-input-suffix { border-left: none; border-radius: 0 4px 4px 0; }
    .lcp-input-group input:first-child, .lcp-input-group select:first-child { border-radius: 4px 0 0 4px; }
    .lcp-input-group input:last-child, .lcp-input-group select:last-child { border-radius: 0 4px 4px 0; }

    /* Field hint */
    .lcp-field-hint { display: block; font-size: 0.75rem; color: #6c757d; margin-top: 0.2rem; }

    /* Readonly value */
    .lcp-readonly-value { padding: 0.4rem 0; font-size: 0.875rem; color: #6c757d; }

    /* Character counter */
    .lcp-char-counter { display: block; font-size: 0.7rem; color: #6c757d; text-align: right; margin-top: 0.15rem; }

    /* Radio group */
    .lcp-radio-group { display: flex; gap: 1rem; flex-wrap: wrap; }
    .lcp-radio-label { display: inline-flex; align-items: center; gap: 0.3rem; cursor: pointer; font-size: 0.875rem; }

    /* Toggle switch */
    .lcp-toggle { position: relative; display: inline-block; width: 44px; height: 24px; cursor: pointer; }
    .lcp-toggle-input { opacity: 0; width: 0; height: 0; position: absolute; }
    .lcp-toggle-slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; border-radius: 24px; transition: background 0.2s; }
    .lcp-toggle-slider::before { content: ""; position: absolute; width: 18px; height: 18px; left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: transform 0.2s; }
    .lcp-toggle-input:checked + .lcp-toggle-slider { background: #0d6efd; }
    .lcp-toggle-input:checked + .lcp-toggle-slider::before { transform: translateX(20px); }

    /* Slider */
    .lcp-slider-wrapper { display: flex; align-items: center; gap: 0.5rem; }
    .lcp-slider { flex: 1; }
    .lcp-slider-value { font-size: 0.875rem; color: #333; min-width: 2em; text-align: right; }

    /* Divider */
    .lcp-divider { position: relative; margin: 0.5rem 0; }
    .lcp-divider hr { border: none; border-top: 1px solid #dee2e6; }
    .lcp-divider-label { position: absolute; top: -0.6em; left: 1rem; background: #fff; padding: 0 0.5rem; font-size: 0.75rem; color: #6c757d; }

    /* Tabs */
    .lcp-tabs { margin-bottom: 1rem; }
    .lcp-tab-nav { display: flex; gap: 0; border-bottom: 2px solid #dee2e6; margin-bottom: 0; }
    .lcp-tab-nav .btn { border: 1px solid transparent; border-bottom: none; border-radius: 4px 4px 0 0; background: transparent; color: #6c757d; margin-bottom: -2px; }
    .lcp-tab-nav .btn.active { background: #fff; color: #333; border-color: #dee2e6; border-bottom-color: #fff; font-weight: 600; }
    .lcp-tab-nav .btn:hover { color: #333; }

    /* Collapsible */
    .lcp-collapsible legend { cursor: pointer; }
    .lcp-collapse-toggle { background: none; border: none; cursor: pointer; font-weight: 600; font-size: inherit; padding: 0; color: inherit; }
    .lcp-collapse-icon::after { content: " \25BC"; font-size: 0.7em; }
    .lcp-collapsed .lcp-collapse-icon::after { content: " \25B6"; }

    /* Empty state */
    .lcp-empty-state { text-align: center; padding: 3rem 1rem; background: #fff; border: 1px solid #dee2e6; border-radius: 4px; color: #6c757d; }
    .lcp-empty-state p { font-size: 1rem; }

    /* Row clickable */
    .lcp-row-clickable { cursor: pointer; }
    .lcp-row-clickable:hover { background: #e9ecef !important; }

    /* Summary row */
    .lcp-summary-row { background: #f8f9fa; font-weight: 600; }
    .lcp-summary-row td { border-top: 2px solid #dee2e6; }

    /* Pinned column */
    .lcp-pinned-left { position: sticky; left: 0; background: inherit; z-index: 1; }

    /* Actions dropdown */
    .lcp-actions-dropdown { position: relative; display: inline-block; }
    .lcp-dropdown-toggle { font-size: 0.8rem; }
    .lcp-dropdown-menu { display: none; position: absolute; right: 0; top: 100%; background: #fff; border: 1px solid #dee2e6; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-width: 120px; z-index: 10; }
    .lcp-actions-dropdown.open .lcp-dropdown-menu { display: block; }
    .lcp-dropdown-item { display: block; padding: 0.4rem 0.75rem; text-decoration: none; color: #333; font-size: 0.875rem; border: none; background: none; width: 100%; text-align: left; cursor: pointer; }
    .lcp-dropdown-item:hover { background: #f8f9fa; }
    .lcp-dropdown-item.btn-danger, .lcp-dropdown-menu button.btn-danger { background: none; border: none; color: #dc3545; padding: 0.4rem 0.75rem; font-size: 0.875rem; width: 100%; text-align: left; cursor: pointer; }
    .lcp-dropdown-menu button.btn-danger:hover { background: #f8f9fa; }
    .lcp-dropdown-menu form.lcp-dropdown-item { padding: 0; margin: 0; }
    .lcp-dropdown-menu button.lcp-dropdown-item { display: block; padding: 0.4rem 0.75rem; text-decoration: none; color: #333; font-size: 0.875rem; border: none; background: none; width: 100%; text-align: left; cursor: pointer; }
    .lcp-dropdown-menu button.lcp-dropdown-item:hover { background: #f8f9fa; }

    /* Nested forms */
    .lcp-nested-section { background: #fff; }
    .lcp-nested-container { margin-bottom: 0.5rem; }
    .lcp-nested-row { display: flex; align-items: flex-end; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e9ecef; border-radius: 4px; margin-bottom: 0.5rem; background: #fafafa; }
    .lcp-nested-row.removed { display: none !important; }
    .lcp-nested-fields { flex: 1; }
    .lcp-nested-remove { flex-shrink: 0; align-self: flex-end; margin-bottom: 0.75rem; }
    .lcp-nested-add { margin-top: 0.5rem; }
    .lcp-empty-nested { color: #6c757d; font-style: italic; padding: 0.5rem 0; }

    /* Drag and drop */
    .lcp-drag-handle { cursor: grab; font-size: 1.2rem; color: #adb5bd; user-select: none; flex-shrink: 0; align-self: center; padding: 0 0.25rem; }
    .lcp-drag-handle:active { cursor: grabbing; }
    .lcp-nested-row.dragging { opacity: 0.4; }
    .lcp-nested-row.drag-over { border-top: 2px solid #0d6efd; }

    /* Conditionally disabled */
    .lcp-conditionally-disabled { position: relative; opacity: 0.6; }
    .lcp-conditionally-disabled input, .lcp-conditionally-disabled select,
    .lcp-conditionally-disabled textarea { pointer-events: none; }
    .lcp-conditionally-disabled::after {
      content: ""; position: absolute; inset: 0; cursor: not-allowed;
    }

    /* Inline action buttons in tables (rendered without .btn class) */
    .lcp-actions form button { cursor: pointer; }

    /* Disabled action */
    .btn.lcp-action-disabled { opacity: 0.5; pointer-events: none; cursor: not-allowed; }

    /* Loading state for dependent selects */
    .lcp-loading { opacity: 0.5; cursor: wait; }

    /* Multi-select validation error */
    .lcp-multi-select-error { display: block; color: #dc3545; font-size: 0.75rem; margin-top: 0.2rem; }

    /* Inline create dialog */
    .lcp-inline-dialog { border: 1px solid #dee2e6; border-radius: 8px; padding: 1.5rem; max-width: 500px; width: 90vw; }
    .lcp-inline-dialog::backdrop { background: rgba(0,0,0,0.4); }
    .lcp-inline-dialog h3 { margin-bottom: 1rem; font-size: 1.1rem; }
    .lcp-inline-dialog .lcp-form-field { margin-bottom: 0.75rem; }
    .lcp-inline-dialog .lcp-form-field label { display: block; font-weight: 500; margin-bottom: 0.25rem; font-size: 0.875rem; }
    .lcp-inline-dialog .lcp-form-field input,
    .lcp-inline-dialog .lcp-form-field textarea,
    .lcp-inline-dialog .lcp-form-field select { width: 100%; padding: 0.4rem 0.75rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.875rem; }
    .lcp-inline-dialog .lcp-form-field input[type="checkbox"] { width: auto; }
    .lcp-dialog-actions { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem; }
    .lcp-dialog-errors { background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 0.5rem 0.75rem; margin-bottom: 0.75rem; color: #721c24; font-size: 0.875rem; display: none; }
    .lcp-ts-add-new { border-top: 1px solid #dee2e6; padding: 0.4rem 0.5rem; }
    .lcp-ts-add-new-btn { background: none; border: none; color: #0d6efd; cursor: pointer; font-size: 0.875rem; padding: 0.25rem 0.5rem; width: 100%; text-align: left; }
    .lcp-ts-add-new-btn:hover { background: #f8f9fa; }

    /* Legacy (archived) options */
    .lcp-legacy-option { font-style: italic; color: #999; }
    .ts-wrapper .ts-dropdown .option.lcp-legacy-option { font-style: italic; color: #999; }

    /* Tree select */
    .lcp-tree-select-wrapper { position: relative; width: 100%; }
    .lcp-tree-trigger { width: 100%; padding: 0.4rem 0.75rem; border: 1px solid #ccc; border-radius: 4px; background: #fff; cursor: pointer; text-align: left; font-size: 0.875rem; color: #333; }
    .lcp-tree-trigger:hover { border-color: #86b7fe; }
    .lcp-tree-dropdown { display: none; position: absolute; z-index: 20; top: 100%; left: 0; right: 0; max-height: 300px; overflow-y: auto; background: #fff; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 2px; }
    .lcp-tree-dropdown.open { display: block; }
    .lcp-tree-node { }
    .lcp-tree-item { display: flex; align-items: center; padding: 0.35rem 0.5rem; cursor: pointer; font-size: 0.875rem; }
    .lcp-tree-item:hover { background: #e9ecef; }
    .lcp-tree-item.selected { background: #0d6efd; color: #fff; }
    .lcp-tree-toggle { width: 1.2rem; text-align: center; flex-shrink: 0; font-size: 0.65rem; color: #6c757d; cursor: pointer; }
    .lcp-tree-item.selected .lcp-tree-toggle { color: #fff; }
    .lcp-tree-label { flex: 1; }
    .lcp-tree-children { padding-left: 1.2rem; }
    .lcp-tree-children.collapsed { display: none; }

    /* Tom Select overrides */
    .ts-wrapper { font-size: 0.875rem; }
    .ts-wrapper .ts-control { border: 1px solid #ccc; border-radius: 4px; padding: 0.3rem 0.5rem; min-height: 34px; background: #fff; }
    .ts-wrapper .ts-control input { font-size: 0.875rem; }
    .lcp-form-field .ts-wrapper .ts-control > input { width: 0; min-width: 0; }
    .ts-wrapper.focus .ts-control { border-color: #86b7fe; box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.25); }
    .ts-wrapper .ts-dropdown { border: 1px solid #ccc; border-radius: 4px; font-size: 0.875rem; }
    .ts-wrapper .ts-dropdown .active { background: #e9ecef; color: #333; }
    .ts-wrapper .ts-dropdown .option[data-disabled] { opacity: 0.5; cursor: not-allowed; }
    .ts-wrapper .ts-dropdown .no-results { padding: 0.5rem 0.75rem; color: #6c757d; font-style: italic; }
    .ts-wrapper .ts-dropdown .loading-more-results { padding: 0.5rem 0.75rem; color: #6c757d; text-align: center; }
    .ts-wrapper.multi .ts-control .item { background: #e9ecef; border: 1px solid #ccc; border-radius: 3px; padding: 0.1rem 0.4rem; font-size: 0.8rem; }
    .ts-wrapper.multi .ts-control .item .remove { border-left: 1px solid #ccc; margin-left: 0.3rem; }

    /* Multi-select display modes */
    .ts-wrapper.multi.lcp-single-line .ts-control { flex-wrap: nowrap; overflow: hidden; }
    .ts-wrapper.multi.lcp-single-line .ts-control > input { min-width: 30px; }
    .ts-wrapper.multi.lcp-single-line .ts-control .item { flex-shrink: 0; }

    /* Navigation */
    .lcp-nav { background: #fff; border-bottom: 1px solid #dee2e6; margin-bottom: 1rem; padding: 0 2rem; }
    .lcp-nav-list { display: flex; gap: 0; list-style: none; margin: 0; padding: 0; }
    .lcp-nav-item a { display: block; padding: 0.75rem 1rem; text-decoration: none; color: #6c757d; font-size: 0.875rem; font-weight: 500; border-bottom: 2px solid transparent; }
    .lcp-nav-item a:hover { color: #333; }
    .lcp-nav-item a.active { color: #0d6efd; border-bottom-color: #0d6efd; }

    /* View switcher */
    .lcp-view-switcher { display: inline-flex; gap: 0; margin-right: 0.5rem; }
    .lcp-view-btn { border-radius: 0; border-right-width: 0; }
    .lcp-view-btn:first-child { border-radius: 4px 0 0 4px; }
    .lcp-view-btn:last-child { border-radius: 0 4px 4px 0; border-right-width: 1px; }
    .lcp-view-btn.active { background: #0d6efd; color: #fff; border-color: #0d6efd; }

    /* Impersonation banner */
    .lcp-impersonation-banner { background: #fff3cd; border-bottom: 2px solid #ffc107; padding: 0.5rem 2rem; display: flex; align-items: center; justify-content: space-between; font-size: 0.875rem; color: #856404; }
    .lcp-impersonation-banner form { display: inline-flex; align-items: center; gap: 0.5rem; }
    .lcp-impersonation-banner select { padding: 0.2rem 0.5rem; border: 1px solid #ffc107; border-radius: 4px; font-size: 0.8rem; }
    .lcp-impersonation-banner .btn { padding: 0.2rem 0.6rem; font-size: 0.8rem; }
    .lcp-impersonation-selector { background: #e9ecef; border-color: #dee2e6; color: #6c757d; }

    /* Responsive breakpoints */
    @media (max-width: 640px) {
      .lcp-grid[data-responsive-mobile="1"] { grid-template-columns: 1fr !important; }
      .lcp-grid[data-responsive-mobile="2"] { grid-template-columns: repeat(2, 1fr) !important; }
      .lcp-hidden-mobile { display: none !important; }
    }
    @media (min-width: 641px) and (max-width: 1024px) {
      .lcp-grid[data-responsive-tablet="1"] { grid-template-columns: 1fr !important; }
      .lcp-grid[data-responsive-tablet="2"] { grid-template-columns: repeat(2, 1fr) !important; }
      .lcp-hidden-tablet { display: none !important; }
    }
  </style>
</head>
<body>
  <nav class="lcp-nav">
    <ul class="lcp-nav-list">
      <% navigable_presenters.each do |entry| %>
        <li class="lcp-nav-item">
          <%= link_to entry[:label], lcp_ruby.resources_path(lcp_slug: entry[:slug]),
                class: entry[:all_slugs].include?(params[:lcp_slug]) ? "active" : "" %>
        </li>
      <% end %>
    </ul>
  </nav>
  <% if impersonating? %>
    <div class="lcp-impersonation-banner">
      <span>Viewing as role: <strong><%= impersonated_role %></strong></span>
      <%= button_to "Stop impersonation", lcp_ruby.stop_impersonate_path, method: :delete, class: "btn btn-danger" %>
    </div>
  <% elsif available_roles_for_impersonation.any? %>
    <div class="lcp-impersonation-banner lcp-impersonation-selector">
      <%= form_with url: lcp_ruby.impersonate_path, method: :post, style: "display: inline-flex; align-items: center; gap: 0.5rem;" do |f| %>
        <label for="impersonate_role">View as:</label>
        <%= select_tag :role, options_for_select(available_roles_for_impersonation), prompt: "Select role...", id: "impersonate_role" %>
        <%= submit_tag "Impersonate", class: "btn" %>
      <% end %>
    </div>
  <% end %>
  <div class="lcp-container">
    <% flash.each do |type, message| %>
      <div class="lcp-flash lcp-flash-<%= type %>"><%= message %></div>
    <% end %>
    <%= yield %>
  </div>
  <script>
    document.addEventListener('submit', function(e) {
      var confirmMsg = (e.submitter && e.submitter.dataset.turboConfirm) ||
                       e.target.dataset.turboConfirm;
      if (confirmMsg && !confirm(confirmMsg)) {
        e.preventDefault();
      }
    });

    /* Tab switching */
    document.addEventListener('click', function(e) {
      var tabBtn = e.target.closest('[data-lcp-tab]');
      if (tabBtn) {
        var tabs = tabBtn.closest('.lcp-tabs');
        if (!tabs) return;
        var index = tabBtn.dataset.lcpTab;
        tabs.querySelectorAll('[data-lcp-tab]').forEach(function(b) { b.classList.remove('active'); });
        tabs.querySelectorAll('[data-lcp-panel]').forEach(function(p) { p.style.display = 'none'; });
        tabBtn.classList.add('active');
        var panel = tabs.querySelector('[data-lcp-panel="' + index + '"]');
        if (panel) panel.style.display = '';
      }
    });

    /* Collapsible sections */
    document.addEventListener('click', function(e) {
      var toggle = e.target.closest('.lcp-collapse-toggle');
      if (toggle) {
        var fieldset = toggle.closest('.lcp-collapsible');
        if (!fieldset) return;
        var content = fieldset.querySelector('.lcp-collapsible-content');
        if (content) {
          var hidden = content.style.display === 'none';
          content.style.display = hidden ? '' : 'none';
          fieldset.classList.toggle('lcp-collapsed', !hidden);
        }
      }
    });

    /* Row click navigation */
    document.addEventListener('click', function(e) {
      var row = e.target.closest('.lcp-row-clickable');
      if (row && !e.target.closest('a, button, form, .lcp-actions')) {
        window.location = row.dataset.href;
      }
    });

    /* Actions dropdown */
    document.addEventListener('click', function(e) {
      var toggle = e.target.closest('.lcp-dropdown-toggle');
      if (toggle) {
        var dropdown = toggle.closest('.lcp-actions-dropdown');
        if (dropdown) {
          document.querySelectorAll('.lcp-actions-dropdown.open').forEach(function(d) {
            if (d !== dropdown) d.classList.remove('open');
          });
          dropdown.classList.toggle('open');
          e.stopPropagation();
        }
      } else {
        document.querySelectorAll('.lcp-actions-dropdown.open').forEach(function(d) { d.classList.remove('open'); });
      }
    });

    /* Nested forms: Add row */
    document.addEventListener('click', function(e) {
      var addBtn = e.target.closest('.lcp-nested-add');
      if (!addBtn) return;
      var section = addBtn.closest('.lcp-nested-section');
      if (!section) return;
      var template = section.querySelector('[data-lcp-nested-template]');
      if (!template) return;
      var container = section.querySelector('.lcp-nested-container');
      if (!container) return;

      var maxCount = parseInt(section.dataset.nestedMax) || 0;
      if (maxCount > 0) {
        var visibleRows = container.querySelectorAll('.lcp-nested-row:not(.removed)');
        if (visibleRows.length >= maxCount) return;
      }

      var clone = template.firstElementChild.cloneNode(true);
      var ts = new Date().getTime();
      clone.innerHTML = clone.innerHTML.replace(/NEW_RECORD/g, ts);
      clone.style.display = '';
      container.appendChild(clone);
    });

    /* Nested forms: Remove row */
    document.addEventListener('click', function(e) {
      var removeBtn = e.target.closest('.lcp-nested-remove');
      if (!removeBtn) return;
      var row = removeBtn.closest('.lcp-nested-row');
      if (!row) return;
      var section = row.closest('.lcp-nested-section');
      var minCount = parseInt(section ? section.dataset.nestedMin : '0') || 0;
      var container = section ? section.querySelector('.lcp-nested-container') : null;
      if (container && minCount > 0) {
        var visibleRows = container.querySelectorAll('.lcp-nested-row:not(.removed)');
        if (visibleRows.length <= minCount) return;
      }

      var destroyField = row.querySelector('.lcp-destroy-flag');
      if (destroyField) {
        destroyField.value = 'true';
        row.classList.add('removed');
      } else {
        row.remove();
      }
    });

    /* Drag and drop reordering for sortable nested forms */
    (function() {
      var draggedRow = null;

      function isInTemplate(el) {
        return !!el.closest('[data-lcp-nested-template]');
      }

      function updatePositionFields(container) {
        var rows = container.querySelectorAll('.lcp-nested-row:not(.removed)');
        rows.forEach(function(row, index) {
          if (isInTemplate(row)) return;
          var posField = row.querySelector('.lcp-position-field');
          if (posField) posField.value = index;
        });
      }

      /* Handle-initiated dragging (mouse) */
      document.addEventListener('mousedown', function(e) {
        var handle = e.target.closest('.lcp-drag-handle');
        if (handle) {
          var row = handle.closest('.lcp-nested-row');
          if (row && !isInTemplate(row)) row.setAttribute('draggable', 'true');
        }
      });

      document.addEventListener('mouseup', function(e) {
        document.querySelectorAll('.lcp-nested-row[draggable]').forEach(function(row) {
          row.removeAttribute('draggable');
        });
      });

      document.addEventListener('dragstart', function(e) {
        var row = e.target.closest('.lcp-nested-row');
        if (!row || !row.closest('[data-sortable]') || isInTemplate(row)) return;
        draggedRow = row;
        row.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });

      document.addEventListener('dragover', function(e) {
        if (!draggedRow) return;
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        var targetRow = e.target.closest('.lcp-nested-row');
        if (!targetRow || targetRow === draggedRow || isInTemplate(targetRow)) return;
        var container = targetRow.closest('.lcp-nested-container');
        if (!container || container !== draggedRow.closest('.lcp-nested-container')) return;

        container.querySelectorAll('.lcp-nested-row.drag-over').forEach(function(r) {
          r.classList.remove('drag-over');
        });
        targetRow.classList.add('drag-over');
      });

      document.addEventListener('drop', function(e) {
        if (!draggedRow) return;
        e.preventDefault();
        var targetRow = e.target.closest('.lcp-nested-row');
        if (!targetRow || targetRow === draggedRow || isInTemplate(targetRow)) return;
        var container = targetRow.closest('.lcp-nested-container');
        if (!container || container !== draggedRow.closest('.lcp-nested-container')) return;

        var rect = targetRow.getBoundingClientRect();
        var midY = rect.top + rect.height / 2;
        if (e.clientY < midY) {
          container.insertBefore(draggedRow, targetRow);
        } else {
          container.insertBefore(draggedRow, targetRow.nextSibling);
        }

        updatePositionFields(container);
      });

      document.addEventListener('dragend', function(e) {
        if (draggedRow) {
          draggedRow.classList.remove('dragging');
          draggedRow.removeAttribute('draggable');
          draggedRow = null;
        }
        document.querySelectorAll('.lcp-nested-row.drag-over').forEach(function(r) {
          r.classList.remove('drag-over');
        });
      });

      /* Touch support for mobile devices */
      var touchDragRow = null;
      var touchStartY = 0;

      document.addEventListener('touchstart', function(e) {
        var handle = e.target.closest('.lcp-drag-handle');
        if (!handle) return;
        var row = handle.closest('.lcp-nested-row');
        if (!row || isInTemplate(row) || !row.closest('[data-sortable]')) return;
        touchDragRow = row;
        touchStartY = e.touches[0].clientY;
        row.classList.add('dragging');
        e.preventDefault();
      }, { passive: false });

      document.addEventListener('touchmove', function(e) {
        if (!touchDragRow) return;
        e.preventDefault();
        var touchY = e.touches[0].clientY;
        var container = touchDragRow.closest('.lcp-nested-container');
        if (!container) return;

        container.querySelectorAll('.lcp-nested-row.drag-over').forEach(function(r) {
          r.classList.remove('drag-over');
        });

        var rows = container.querySelectorAll('.lcp-nested-row:not(.removed)');
        for (var i = 0; i < rows.length; i++) {
          if (rows[i] === touchDragRow || isInTemplate(rows[i])) continue;
          var rect = rows[i].getBoundingClientRect();
          if (touchY >= rect.top && touchY <= rect.bottom) {
            rows[i].classList.add('drag-over');
            break;
          }
        }
      }, { passive: false });

      document.addEventListener('touchend', function(e) {
        if (!touchDragRow) return;
        var container = touchDragRow.closest('.lcp-nested-container');
        var overRow = container && container.querySelector('.lcp-nested-row.drag-over');

        if (overRow && overRow !== touchDragRow) {
          var rect = overRow.getBoundingClientRect();
          var lastTouchY = e.changedTouches[0].clientY;
          var midY = rect.top + rect.height / 2;
          if (lastTouchY < midY) {
            container.insertBefore(touchDragRow, overRow);
          } else {
            container.insertBefore(touchDragRow, overRow.nextSibling);
          }
          updatePositionFields(container);
        }

        touchDragRow.classList.remove('dragging');
        if (container) {
          container.querySelectorAll('.lcp-nested-row.drag-over').forEach(function(r) {
            r.classList.remove('drag-over');
          });
        }
        touchDragRow = null;
      });

      /* Update positions after adding a row */
      document.addEventListener('click', function(e) {
        var addBtn = e.target.closest('.lcp-nested-add');
        if (!addBtn) return;
        var section = addBtn.closest('.lcp-nested-section');
        if (!section || !section.dataset.sortable) return;
        /* Use setTimeout to run after the main add handler has appended the clone */
        setTimeout(function() {
          var container = section.querySelector('.lcp-nested-container');
          if (container) updatePositionFields(container);
        }, 0);
      });

      /* Update positions after removing a row */
      document.addEventListener('click', function(e) {
        var removeBtn = e.target.closest('.lcp-nested-remove');
        if (!removeBtn) return;
        var section = removeBtn.closest('.lcp-nested-section');
        if (!section || !section.dataset.sortable) return;
        setTimeout(function() {
          var container = section.querySelector('.lcp-nested-container');
          if (container) updatePositionFields(container);
        }, 0);
      });

      /* Initialize position fields on page load */
      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[data-sortable]').forEach(function(section) {
          var container = section.querySelector('.lcp-nested-container');
          if (container) updatePositionFields(container);
        });
      });
    })();

    /* Slider value display */
    document.addEventListener('input', function(e) {
      if (e.target.classList.contains('lcp-slider')) {
        var wrapper = e.target.closest('.lcp-slider-wrapper');
        if (wrapper) {
          var display = wrapper.querySelector('.lcp-slider-value');
          if (display) display.textContent = e.target.value;
        }
      }
    });
    /* Initialize slider values on load */
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.lcp-slider').forEach(function(slider) {
        var wrapper = slider.closest('.lcp-slider-wrapper');
        if (wrapper) {
          var display = wrapper.querySelector('.lcp-slider-value');
          if (display) display.textContent = slider.value;
        }
      });
    });

    /* Character counter */
    document.addEventListener('input', function(e) {
      var counter = e.target.parentNode && e.target.parentNode.querySelector('.lcp-char-counter');
      if (counter && e.target.maxLength > 0) {
        counter.textContent = e.target.value.length + ' / ' + e.target.maxLength;
      }
    });
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.lcp-char-counter').forEach(function(counter) {
        var textarea = counter.parentNode.querySelector('textarea');
        if (textarea && textarea.maxLength > 0) {
          counter.textContent = textarea.value.length + ' / ' + textarea.maxLength;
        }
      });
    });

    /* Shared field value reader — used by conditional rendering and cascading selects */
    function getFieldValue(form, fieldName) {
      /* Handle checkboxes (Rails hidden+checkbox pattern) */
      var checkboxes = form.querySelectorAll('input[type="checkbox"][name$="[' + fieldName + ']"]');
      if (checkboxes.length > 0) {
        return checkboxes[checkboxes.length - 1].checked ? 'true' : 'false';
      }
      /* Handle radio buttons */
      var radios = form.querySelectorAll('input[type="radio"][name$="[' + fieldName + ']"]');
      if (radios.length > 0) {
        for (var i = 0; i < radios.length; i++) {
          if (radios[i].checked) return radios[i].value;
        }
        return '';
      }
      /* Handle select and other inputs */
      var input = form.querySelector('[name$="[' + fieldName + ']"]');
      if (input) return input.value || '';
      return '';
    }

    /* Conditional rendering (visible_when / disable_when) */
    (function() {
      function evaluateCondition(value, operator, conditionValue) {
        switch (operator) {
          case 'eq':
            return String(value) === String(conditionValue);
          case 'not_eq': case 'neq':
            return String(value) !== String(conditionValue);
          case 'in': {
            const inList = String(conditionValue).split(',');
            return inList.indexOf(String(value)) !== -1;
          }
          case 'not_in': {
            const notInList = String(conditionValue).split(',');
            return notInList.indexOf(String(value)) === -1;
          }
          case 'gt':
            return parseFloat(value) > parseFloat(conditionValue);
          case 'gte':
            return parseFloat(value) >= parseFloat(conditionValue);
          case 'lt':
            return parseFloat(value) < parseFloat(conditionValue);
          case 'lte':
            return parseFloat(value) <= parseFloat(conditionValue);
          case 'present':
            return value !== '' && value !== null && value !== undefined;
          case 'blank':
            return value === '' || value === null || value === undefined;
          case 'matches':
            try { return new RegExp(conditionValue).test(String(value)); } catch(e) { return false; }
          case 'not_matches':
            try { return !new RegExp(conditionValue).test(String(value)); } catch(e) { return true; }
          default:
            return String(value) === String(conditionValue);
        }
      }

      function applyConditions(form) {
        const elements = form.querySelectorAll('[data-lcp-conditional]');
        elements.forEach(function(el) {
          /* visible_when */
          const visField = el.getAttribute('data-lcp-visible-field');
          if (visField) {
            const visOp = el.getAttribute('data-lcp-visible-operator') || 'eq';
            const visVal = el.getAttribute('data-lcp-visible-value');
            const fieldValue = getFieldValue(form, visField);
            const visible = evaluateCondition(fieldValue, visOp, visVal);
            el.style.display = visible ? '' : 'none';

            /* When a tab button is hidden/shown, also hide/show its panel */
            if (el.getAttribute('data-lcp-conditional') === 'tab') {
              const tabIndex = el.getAttribute('data-lcp-tab');
              const tabs = el.closest('.lcp-tabs');
              if (tabs && tabIndex) {
                const panel = tabs.querySelector('[data-lcp-panel="' + tabIndex + '"]');
                if (panel && !visible) {
                  panel.style.display = 'none';
                  el.classList.remove('active');
                }
              }
            }
          }
          /* disable_when */
          const disField = el.getAttribute('data-lcp-disable-field');
          if (disField) {
            const disOp = el.getAttribute('data-lcp-disable-operator') || 'eq';
            const disVal = el.getAttribute('data-lcp-disable-value');
            const disFieldValue = getFieldValue(form, disField);
            const disabled = evaluateCondition(disFieldValue, disOp, disVal);
            if (disabled) {
              el.classList.add('lcp-conditionally-disabled');
            } else {
              el.classList.remove('lcp-conditionally-disabled');
            }
            /* Properly disable/enable all form controls and Tom Select instances */
            el.querySelectorAll('input, select, textarea').forEach(function(ctrl) {
              ctrl.disabled = disabled;
              if (ctrl.tomselect) {
                disabled ? ctrl.tomselect.disable() : ctrl.tomselect.enable();
              }
            });
          }
        });

        /* Ensure a visible tab is active when active tab gets hidden */
        form.querySelectorAll('.lcp-tabs').forEach(function(tabs) {
          const activeBtn = tabs.querySelector('.lcp-tab-nav .btn.active');
          if (!activeBtn || activeBtn.style.display === 'none') {
            const firstVisible = tabs.querySelector('.lcp-tab-nav .btn:not([style*="display:none"]):not([style*="display: none"])');
            if (firstVisible) {
              firstVisible.classList.add('active');
              const idx = firstVisible.getAttribute('data-lcp-tab');
              const panel = tabs.querySelector('[data-lcp-panel="' + idx + '"]');
              if (panel) panel.style.display = '';
            }
          }
        });
      }

      /* Delegated event listeners for form changes */
      function handleFormChange(e) {
        const form = e.target.closest('form');
        if (form && form.querySelector('[data-lcp-conditional]')) {
          applyConditions(form);
        }
      }

      document.addEventListener('change', handleFormChange);
      document.addEventListener('input', handleFormChange);

      /* Initial evaluation on page load */
      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('form').forEach(function(form) {
          if (form.querySelector('[data-lcp-conditional]')) {
            applyConditions(form);
          }
        });
      });

      /* AJAX for service conditions */
      let debounceTimer = null;
      document.addEventListener('change', function(e) {
        const form = e.target.closest('form');
        if (!form) return;
        const condUrl = form.getAttribute('data-lcp-conditions-url');
        if (!condUrl) return;

        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(function() {
          const formData = new FormData(form);
          const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
          const headers = { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' };
          if (csrfToken) headers['X-CSRF-Token'] = csrfToken;
          fetch(condUrl, {
            method: 'POST',
            body: formData,
            headers: headers
          }).then(function(r) { return r.json(); }).then(function(data) {
            const serviceEls = form.querySelectorAll('[data-lcp-service-condition]');
            serviceEls.forEach(function(el) {
              const fieldName = el.getAttribute('data-lcp-field-name');
              const condType = el.getAttribute('data-lcp-conditional');
              const serviceTypes = el.getAttribute('data-lcp-service-condition').split(',');

              serviceTypes.forEach(function(serviceType) {
                let key;
                if (condType === 'field') {
                  key = fieldName + '_' + serviceType;
                } else {
                  key = condType + '_' + serviceType;
                }

                if (data.hasOwnProperty(key)) {
                  if (serviceType === 'visible') {
                    el.style.display = data[key] ? '' : 'none';
                  } else if (serviceType === 'disable') {
                    if (data[key]) {
                      el.classList.add('lcp-conditionally-disabled');
                    } else {
                      el.classList.remove('lcp-conditionally-disabled');
                    }
                  }
                }
              });
            });
          }).catch(function(err) { console.warn('[LcpRuby] Service condition evaluation failed:', err); });
        }, 300);
      });
    })();

    // Dependent (cascading) select
    (function() {
      var form = document.querySelector('form.lcp-form');
      if (!form) return;

      var dependents = form.querySelectorAll('[data-lcp-depends-on]');
      if (!dependents.length) return;

      var selectOptionsPath = form.dataset.lcpSelectOptionsPath;
      if (!selectOptionsPath) return;

      dependents.forEach(function(dep) {
        var parentFieldName = dep.getAttribute('data-lcp-depends-on');
        var resetStrategy = dep.getAttribute('data-lcp-depends-reset') || 'clear';

        // Find ALL parent inputs (supports select, radio buttons, checkboxes)
        var parentInputs = form.querySelectorAll(
          '[name="record[' + parentFieldName + ']"], ' +
          'input[type="radio"][name="record[' + parentFieldName + ']"], ' +
          'input[type="checkbox"][name$="[' + parentFieldName + ']"]'
        );
        if (!parentInputs.length) return;

        function handleParentChange() {
          var parentValue = getFieldValue(form, parentFieldName);
          var fieldName = dep.name.replace(/^record\[/, '').replace(/\]$/, '');

          // When parent is blank, just clear the dependent — no fetch needed
          if (!parentValue || parentValue === '') {
            var blankOpt = dep.querySelector('option[value=""]');
            var blankTxt = blankOpt ? blankOpt.textContent : '';
            if (dep.tomselect) {
              dep.tomselect.destroy();
              dep.innerHTML = '';
              if (blankTxt) {
                var bo = document.createElement('option');
                bo.value = ''; bo.textContent = blankTxt;
                dep.appendChild(bo);
              }
              dep.value = '';
              new TomSelect(dep, { plugins: [], create: false, allowEmptyOption: true });
            } else {
              dep.innerHTML = '';
              if (blankOpt) dep.appendChild(blankOpt.cloneNode(true));
              dep.value = '';
            }
            dep._lcpKeepIfValid = false;
            dep.dispatchEvent(new Event('change', { bubbles: true }));
            dep.dispatchEvent(new CustomEvent('lcp:cascade-done'));
            return;
          }

          var url = selectOptionsPath + '?field=' + encodeURIComponent(fieldName) +
                    '&depends_on[' + encodeURIComponent(parentFieldName) + ']=' + encodeURIComponent(parentValue);

          // Disable select and show loading indicator during fetch
          dep.disabled = true;
          dep.classList.add('lcp-loading');

          var effectiveReset = dep._lcpKeepIfValid ? 'keep_if_valid' : resetStrategy;

          fetch(url, { headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' } })
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
              var currentValue = dep.value;
              var includeBlank = dep.querySelector('option[value=""]');
              var blankText = includeBlank ? includeBlank.textContent : '';

              // Collect all valid values
              var allValues = [];
              var flatOpts = [];

              if (Array.isArray(data) && data.length > 0 && data[0].group !== undefined) {
                data.forEach(function(g) {
                  g.options.forEach(function(opt) {
                    flatOpts.push(opt);
                    allValues.push(String(opt.value));
                  });
                });
              } else if (Array.isArray(data)) {
                data.forEach(function(opt) {
                  flatOpts.push(opt);
                  allValues.push(String(opt.value));
                });
              }

              var keepValid = effectiveReset === 'keep_if_valid' && allValues.indexOf(currentValue) !== -1;

              if (dep.tomselect) {
                // Destroy and re-init Tom Select to fully reset the sifter
                var hadInlineCreate = dep.hasAttribute('data-lcp-inline-create');
                var isRemote = dep.getAttribute('data-lcp-search') === 'remote';
                dep.tomselect.destroy();

                // Rebuild <option> elements on the underlying <select>
                dep.innerHTML = '';
                if (includeBlank || blankText) {
                  var blankEl = document.createElement('option');
                  blankEl.value = '';
                  blankEl.textContent = blankText;
                  dep.appendChild(blankEl);
                }
                flatOpts.forEach(function(opt) {
                  var el = document.createElement('option');
                  el.value = opt.value;
                  el.textContent = opt.label;
                  if (opt.disabled) el.disabled = true;
                  dep.appendChild(el);
                });

                dep.value = keepValid ? currentValue : '';
                dep.disabled = false; // clear before Tom Select init so it starts enabled
                dep.classList.remove('lcp-loading'); // clear before init — Tom Select copies classes to wrapper

                // Re-init Tom Select with local mode (options are already populated)
                var tsSettings = { plugins: [], create: false, allowEmptyOption: true };
                var newTs = new TomSelect(dep, tsSettings);

                // Re-attach inline create footer if needed
                if (hadInlineCreate) {
                  var footer = document.createElement('div');
                  footer.className = 'lcp-ts-add-new';
                  var addBtnEl = document.createElement('button');
                  addBtnEl.type = 'button';
                  addBtnEl.className = 'lcp-ts-add-new-btn';
                  addBtnEl.textContent = window.LcpI18n && window.LcpI18n.select.add_new || '+ Add new...';
                  addBtnEl.addEventListener('mousedown', function(ev) {
                    ev.preventDefault();
                    ev.stopPropagation();
                    newTs.blur();
                    window.lcpOpenInlineCreate(dep);
                  });
                  footer.appendChild(addBtnEl);
                  newTs.dropdown_content.parentNode.appendChild(footer);
                }
              } else {
                // Plain <select> — rebuild options
                dep.innerHTML = '';
                if (includeBlank) {
                  dep.appendChild(includeBlank.cloneNode(true));
                }

                if (Array.isArray(data) && data.length > 0 && data[0].group !== undefined) {
                  data.forEach(function(g) {
                    var optgroup = document.createElement('optgroup');
                    optgroup.label = g.group;
                    g.options.forEach(function(opt) {
                      var el = document.createElement('option');
                      el.value = opt.value;
                      el.textContent = opt.label;
                      if (opt.disabled) el.disabled = true;
                      optgroup.appendChild(el);
                    });
                    dep.appendChild(optgroup);
                  });
                } else {
                  flatOpts.forEach(function(opt) {
                    var el = document.createElement('option');
                    el.value = opt.value;
                    el.textContent = opt.label;
                    if (opt.disabled) el.disabled = true;
                    dep.appendChild(el);
                  });
                }

                dep.value = keepValid ? currentValue : '';
              }

              dep._lcpKeepIfValid = false;
              dep.dispatchEvent(new Event('change', { bubbles: true }));
            })
            .catch(function(err) { console.warn('[LcpRuby] Dependent select fetch failed:', err); })
            .finally(function() {
              dep.disabled = false;
              dep.classList.remove('lcp-loading');
              if (dep.tomselect) dep.tomselect.enable();
              dep.dispatchEvent(new CustomEvent('lcp:cascade-done'));
            });
        }

        // Bind change listener to each parent input
        parentInputs.forEach(function(parentInput) {
          parentInput.addEventListener('change', handleParentChange);
        });
      });
    })();

    // Reverse cascade: auto-fill parent selects when a child is selected
    (function() {
      var form = document.querySelector('form.lcp-form');
      if (!form) return;

      var dependents = form.querySelectorAll('[data-lcp-depends-on]');
      if (!dependents.length) return;

      var selectOptionsPath = form.dataset.lcpSelectOptionsPath;
      if (!selectOptionsPath) return;

      // Build a map of field_name -> depends_on chain (bottom to top)
      function getAncestorChain(dep) {
        var chain = [];
        var current = dep;
        var seen = {};
        while (current) {
          var parentFieldName = current.getAttribute('data-lcp-depends-on');
          if (!parentFieldName || seen[parentFieldName]) break;
          seen[parentFieldName] = true;
          var parentEl = form.querySelector('[name="record[' + parentFieldName + ']"]');
          chain.push({ fieldName: parentFieldName, element: parentEl });
          current = parentEl;
        }
        return chain;
      }

      function hasEmptyAncestor(chain) {
        for (var i = 0; i < chain.length; i++) {
          if (!chain[i].element) return true;
          var val = chain[i].element.value;
          if (!val || val === '') return true;
        }
        return false;
      }

      function setFieldValue(fieldEl, value, label) {
        if (!fieldEl) return;
        if (fieldEl.tomselect) {
          fieldEl.tomselect.addOption({ value: String(value), text: label });
          fieldEl.tomselect.setValue(String(value), true); // silent
        } else {
          // Ensure the option exists
          var existing = fieldEl.querySelector('option[value="' + value + '"]');
          if (!existing) {
            var opt = document.createElement('option');
            opt.value = value;
            opt.textContent = label;
            fieldEl.appendChild(opt);
          }
          fieldEl.value = String(value);
        }
      }

      // Trigger cascade from the topmost ancestor down, waiting for each level
      function cascadeFromTop(chain, callback) {
        // chain is bottom-to-top; reverse for top-down processing
        var topDown = chain.slice().reverse();
        var idx = 0;

        function next() {
          if (idx >= topDown.length) {
            if (callback) callback();
            return;
          }
          var entry = topDown[idx];
          idx++;
          if (!entry.element) { next(); return; }

          // Set keep_if_valid flag so cascade preserves child values
          // Find all dependents of this field and set flag
          var fieldName = entry.fieldName;
          var children = form.querySelectorAll('[data-lcp-depends-on="' + fieldName + '"]');
          children.forEach(function(child) { child._lcpKeepIfValid = true; });

          // Listen for cascade-done on the immediate child
          if (children.length > 0) {
            var child = children[0];
            var onDone = function() {
              child.removeEventListener('lcp:cascade-done', onDone);
              next();
            };
            child.addEventListener('lcp:cascade-done', onDone);
          }

          // Dispatch change to trigger cascade
          entry.element.dispatchEvent(new Event('change', { bubbles: true }));

          // If no children to cascade, proceed immediately
          if (children.length === 0) { next(); }
        }

        next();
      }

      dependents.forEach(function(dep) {
        dep.addEventListener('change', function() {
          var selectedValue = dep.value;
          if (!selectedValue || selectedValue === '') return;

          var chain = getAncestorChain(dep);
          if (!chain.length) return;
          if (!hasEmptyAncestor(chain)) return;

          var fieldName = dep.name.replace(/^record\[/, '').replace(/\]$/, '');
          var url = selectOptionsPath + '?field=' + encodeURIComponent(fieldName) +
                    '&ancestors_for=' + encodeURIComponent(selectedValue);

          fetch(url, { headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' } })
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
              var ancestors = data.ancestors;
              if (!ancestors || !ancestors.length) return;

              // Set values top-down (ancestors are bottom-to-top from server, reverse for top-down)
              var topDown = ancestors.slice().reverse();
              topDown.forEach(function(anc) {
                var el = form.querySelector('[name="record[' + anc.field + ']"]');
                if (el) {
                  setFieldValue(el, anc.value, anc.label);
                }
              });

              // Now trigger cascade from the topmost parent down to populate dropdowns
              cascadeFromTop(chain, null);
            })
            .catch(function(err) { console.warn('[LcpRuby] Reverse cascade failed:', err); });
        });
      });
    })();

    // Multi-select min/max validation via native constraint API
    (function() {
      var form = document.querySelector('form.lcp-form');
      if (!form) return;

      var multiSelects = form.querySelectorAll('select[multiple][data-min], select[multiple][data-max]');
      if (!multiSelects.length) return;

      function validate(sel) {
        var count = sel.selectedOptions.length;
        var min = sel.getAttribute('data-min');
        var max = sel.getAttribute('data-max');
        var msgs = [];

        if (min && count < parseInt(min, 10)) {
          msgs.push('Select at least ' + min + ' item(s)');
        }
        if (max && count > parseInt(max, 10)) {
          msgs.push('Select at most ' + max + ' item(s)');
        }

        var msgEl = sel.parentElement.querySelector('.lcp-multi-select-error');
        if (msgs.length > 0) {
          if (!msgEl) {
            msgEl = document.createElement('span');
            msgEl.className = 'lcp-multi-select-error lcp-field-error';
            sel.parentElement.appendChild(msgEl);
          }
          msgEl.textContent = msgs.join('. ');
          sel.setCustomValidity(msgs.join('. '));
        } else {
          if (msgEl) msgEl.remove();
          sel.setCustomValidity('');
        }
      }

      multiSelects.forEach(function(sel) {
        sel.addEventListener('change', function() { validate(sel); });
        validate(sel); // validate initial state (e.g. editing existing record)
      });
    })();
  </script>
  <script>
    window.LcpI18n = {
      select: {
        include_blank: <%= I18n.t("lcp_ruby.select.include_blank").to_json.html_safe %>,
        no_results: <%= I18n.t("lcp_ruby.select.no_results").to_json.html_safe %>,
        loading_more: <%= I18n.t("lcp_ruby.select.loading_more").to_json.html_safe %>,
        add_new: <%= I18n.t("lcp_ruby.select.add_new").to_json.html_safe %>
      },
      form: {
        create: <%= I18n.t("lcp_ruby.form.create").to_json.html_safe %>,
        cancel: <%= I18n.t("lcp_ruby.form.cancel").to_json.html_safe %>
      },
      tree_select: {
        expand: <%= I18n.t("lcp_ruby.tree_select.expand").to_json.html_safe %>,
        collapse: <%= I18n.t("lcp_ruby.tree_select.collapse").to_json.html_safe %>
      }
    };
  </script>
  <%= javascript_include_tag "lcp_ruby/tom-select.base.min" if Rails.application.config.respond_to?(:assets) %>
  <script>
    // Tom Select initialization
    (function() {
      if (typeof TomSelect === 'undefined') return;

      document.addEventListener('DOMContentLoaded', function() {
        var selects = document.querySelectorAll('select[data-lcp-search]');
        selects.forEach(function(selectEl) {
          var mode = selectEl.getAttribute('data-lcp-search');

          if (mode === 'remote') {
            // Remote mode: AJAX search with pagination
            var searchUrl = selectEl.getAttribute('data-lcp-search-url');
            var perPage = parseInt(selectEl.getAttribute('data-lcp-per-page')) || 25;
            var minQuery = parseInt(selectEl.getAttribute('data-lcp-min-query')) || 1;
            var isMultiple = selectEl.hasAttribute('multiple');
            var plugins = [];
            if (isMultiple) plugins.push('remove_button');

            // Clear pre-rendered options for remote mode (fetched on demand)
            var blankOpt = selectEl.querySelector('option[value=""]');
            selectEl.innerHTML = '';
            if (blankOpt) selectEl.appendChild(blankOpt);

            var lastQuery = '';
            new TomSelect(selectEl, {
              valueField: 'value',
              labelField: 'text',
              searchField: 'text',
              plugins: plugins,
              maxOptions: null,
              load: function(query, callback) {
                if (query.length < minQuery) return callback();
                var self = this;
                // Reset page counter when query changes
                if (query !== lastQuery) {
                  self.currentPage = 1;
                  lastQuery = query;
                }
                var page = self.currentPage || 1;
                var url = searchUrl + '&q=' + encodeURIComponent(query) + '&page=' + page + '&per_page=' + perPage;

                // Include depends_on parent filter for remote dependent selects
                var dependsOn = selectEl.getAttribute('data-lcp-depends-on');
                if (dependsOn) {
                  var parentForm = selectEl.closest('form');
                  if (parentForm) {
                    var parentValue = getFieldValue(parentForm, dependsOn);
                    if (parentValue) {
                      url += '&depends_on[' + encodeURIComponent(dependsOn) + ']=' + encodeURIComponent(parentValue);
                    }
                  }
                }

                fetch(url, { headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' } })
                  .then(function(resp) { return resp.json(); })
                  .then(function(data) {
                    var options = data.options || data;
                    var items = options.map(function(opt) {
                      return { value: String(opt.value), text: opt.label, disabled: !!opt.disabled };
                    });
                    callback(items);
                    if (data.has_more) {
                      self.currentPage = page + 1;
                    }
                  })
                  .catch(function() { callback(); });
              },
              shouldLoad: function(query) {
                return query.length >= minQuery;
              },
              render: {
                no_results: function() {
                  return '<div class="no-results">' + (window.LcpI18n && window.LcpI18n.select.no_results || 'No results found') + '</div>';
                },
                loading_more: function() {
                  return '<div class="loading-more-results">' + (window.LcpI18n && window.LcpI18n.select.loading_more || 'Loading more...') + '</div>';
                }
              }
            });
          } else {
            // Local mode: client-side filtering of inline options
            var isMultiple = selectEl.hasAttribute('multiple');
            var plugins = [];
            if (isMultiple) plugins.push('remove_button');

            new TomSelect(selectEl, {
              plugins: plugins,
              create: false,
              allowEmptyOption: true
            });
          }

          // Apply display mode class to Tom Select wrapper
          var displayMode = selectEl.getAttribute('data-lcp-display-mode');
          if (displayMode && selectEl.tomselect) {
            selectEl.tomselect.wrapper.classList.add('lcp-' + displayMode);
          }

          // Inline create: add "Add new..." footer button to Tom Select dropdown
          if (selectEl.hasAttribute('data-lcp-inline-create') && selectEl.tomselect) {
            var ts = selectEl.tomselect;
            var footer = document.createElement('div');
            footer.className = 'lcp-ts-add-new';
            var addBtn = document.createElement('button');
            addBtn.type = 'button';
            addBtn.className = 'lcp-ts-add-new-btn';
            addBtn.textContent = window.LcpI18n && window.LcpI18n.select.add_new || '+ Add new...';
            addBtn.addEventListener('mousedown', function(ev) {
              ev.preventDefault();
              ev.stopPropagation();
              ts.blur();
              window.lcpOpenInlineCreate(selectEl);
            });
            footer.appendChild(addBtn);
            ts.dropdown_content.parentNode.appendChild(footer);
          }
        });
      });
    })();
  </script>

  <script>
    // Tree select widget
    (function() {
      function initTreeSelect(hiddenInput) {
        var treeData = JSON.parse(hiddenInput.getAttribute('data-lcp-tree-data') || '[]');
        var includeBlank = hiddenInput.getAttribute('data-lcp-tree-include-blank') || '';
        var wrapper = hiddenInput.closest('.lcp-tree-select-wrapper');
        if (!wrapper) return;

        var trigger = wrapper.querySelector('.lcp-tree-trigger');
        var dropdown = wrapper.querySelector('.lcp-tree-dropdown');
        if (!trigger || !dropdown) return;

        function renderNodes(nodes, container, depth) {
          nodes.forEach(function(node) {
            var nodeEl = document.createElement('div');
            nodeEl.className = 'lcp-tree-node';

            var itemEl = document.createElement('div');
            itemEl.className = 'lcp-tree-item';
            itemEl.style.paddingLeft = (0.5 + depth * 1.2) + 'rem';
            if (String(node.id) === String(hiddenInput.value)) {
              itemEl.classList.add('selected');
            }

            var toggleEl = document.createElement('span');
            toggleEl.className = 'lcp-tree-toggle';
            if (node.children && node.children.length > 0) {
              toggleEl.textContent = '\u25BC';
            }
            itemEl.appendChild(toggleEl);

            var labelEl = document.createElement('span');
            labelEl.className = 'lcp-tree-label';
            labelEl.textContent = node.label;
            itemEl.appendChild(labelEl);

            nodeEl.appendChild(itemEl);

            if (node.children && node.children.length > 0) {
              var childrenEl = document.createElement('div');
              childrenEl.className = 'lcp-tree-children';
              renderNodes(node.children, childrenEl, depth + 1);
              nodeEl.appendChild(childrenEl);

              toggleEl.addEventListener('click', function(e) {
                e.stopPropagation();
                childrenEl.classList.toggle('collapsed');
                toggleEl.textContent = childrenEl.classList.contains('collapsed') ? '\u25B6' : '\u25BC';
              });
            }

            labelEl.addEventListener('click', function(e) {
              e.stopPropagation();
              // Deselect all
              dropdown.querySelectorAll('.lcp-tree-item.selected').forEach(function(el) {
                el.classList.remove('selected');
              });
              itemEl.classList.add('selected');
              hiddenInput.value = node.id;
              trigger.textContent = node.label;
              dropdown.classList.remove('open');
              hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
            });

            container.appendChild(nodeEl);
          });
        }

        // Add blank option
        if (includeBlank) {
          var blankItem = document.createElement('div');
          blankItem.className = 'lcp-tree-item';
          blankItem.style.fontStyle = 'italic';
          blankItem.style.color = '#6c757d';
          blankItem.textContent = includeBlank;
          if (!hiddenInput.value || hiddenInput.value === '') {
            blankItem.classList.add('selected');
          }
          blankItem.addEventListener('click', function(e) {
            e.stopPropagation();
            dropdown.querySelectorAll('.lcp-tree-item.selected').forEach(function(el) {
              el.classList.remove('selected');
            });
            blankItem.classList.add('selected');
            hiddenInput.value = '';
            trigger.textContent = includeBlank;
            dropdown.classList.remove('open');
            hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
          });
          dropdown.appendChild(blankItem);
        }

        renderNodes(treeData, dropdown, 0);

        // Toggle dropdown on trigger click
        trigger.addEventListener('click', function(e) {
          e.stopPropagation();
          dropdown.classList.toggle('open');
        });

        // Close dropdown on outside click
        document.addEventListener('click', function(e) {
          if (!wrapper.contains(e.target)) {
            dropdown.classList.remove('open');
          }
        });
      }

      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[data-lcp-tree-select]').forEach(function(input) {
          initTreeSelect(input);
        });
      });
    })();
  </script>

  <!-- Inline create dialog -->
  <dialog id="lcp-inline-create-dialog" class="lcp-inline-dialog">
    <h3 id="lcp-inline-dialog-title"></h3>
    <div class="lcp-dialog-errors" id="lcp-inline-dialog-errors"></div>
    <div id="lcp-inline-dialog-content"></div>
    <div class="lcp-dialog-actions">
      <button type="button" class="btn" id="lcp-inline-dialog-cancel"><%= I18n.t("lcp_ruby.form.cancel") %></button>
      <button type="button" class="btn btn-primary" id="lcp-inline-dialog-save"><%= I18n.t("lcp_ruby.form.create") %></button>
    </div>
  </dialog>

  <script>
    // Inline create functionality
    (function() {
      var dialog = document.getElementById('lcp-inline-create-dialog');
      if (!dialog) return;

      var currentSelectEl = null;

      window.lcpOpenInlineCreate = function(selectEl) {
        currentSelectEl = selectEl;
        var formUrl = selectEl.getAttribute('data-lcp-inline-create-form-url');
        var targetModel = selectEl.getAttribute('data-lcp-target-model');

        var titleEl = document.getElementById('lcp-inline-dialog-title');
        titleEl.textContent = (window.LcpI18n && window.LcpI18n.form.create || 'Create') + ' ' + (targetModel || '').replace(/_/g, ' ');

        var contentEl = document.getElementById('lcp-inline-dialog-content');
        contentEl.innerHTML = '';

        var errorsEl = document.getElementById('lcp-inline-dialog-errors');
        errorsEl.style.display = 'none';
        errorsEl.textContent = '';

        fetch(formUrl + '?target_model=' + encodeURIComponent(targetModel), {
          headers: { 'Accept': 'text/html', 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function(resp) {
          if (!resp.ok) throw new Error('Failed to load form');
          return resp.text();
        })
        .then(function(html) {
          contentEl.innerHTML = html;
          dialog.showModal();
        })
        .catch(function(err) {
          console.warn('[LcpRuby] Inline create form load failed:', err);
        });
      };

      // Cancel button
      document.getElementById('lcp-inline-dialog-cancel').addEventListener('click', function() {
        dialog.close();
        currentSelectEl = null;
      });

      // Close on backdrop click
      dialog.addEventListener('click', function(e) {
        if (e.target === dialog) {
          dialog.close();
          currentSelectEl = null;
        }
      });

      // Save button
      document.getElementById('lcp-inline-dialog-save').addEventListener('click', function() {
        if (!currentSelectEl) return;

        var createUrl = currentSelectEl.getAttribute('data-lcp-inline-create-url');
        var targetModel = currentSelectEl.getAttribute('data-lcp-target-model');
        var labelMethod = currentSelectEl.getAttribute('data-lcp-label-method');

        var contentEl = document.getElementById('lcp-inline-dialog-content');
        var errorsEl = document.getElementById('lcp-inline-dialog-errors');

        // Build form data from inline fields
        var formData = new FormData();
        var inputs = contentEl.querySelectorAll('input, textarea, select');
        inputs.forEach(function(input) {
          if (input.type === 'hidden' && input.nextElementSibling && input.nextElementSibling.type === 'checkbox') {
            // Skip Rails hidden field paired with a checkbox; the checkbox handles the value
            return;
          }
          if (input.type === 'checkbox') {
            formData.set(input.name, input.checked ? '1' : '0');
          } else {
            formData.append(input.name, input.value);
          }
        });

        var url = createUrl + '?target_model=' + encodeURIComponent(targetModel);
        if (labelMethod) url += '&label_method=' + encodeURIComponent(labelMethod);

        var csrfToken = document.querySelector('meta[name="csrf-token"]');
        var headers = { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' };
        if (csrfToken) headers['X-CSRF-Token'] = csrfToken.content;

        fetch(url, {
          method: 'POST',
          body: formData,
          headers: headers
        })
        .then(function(resp) { return resp.json().then(function(data) { return { ok: resp.ok, data: data }; }); })
        .then(function(result) {
          if (result.ok) {
            // Add new option to Tom Select and select it
            if (currentSelectEl.tomselect) {
              currentSelectEl.tomselect.addOption({ value: String(result.data.id), text: result.data.label });
              currentSelectEl.tomselect.setValue(String(result.data.id), false);
              currentSelectEl.tomselect.refreshOptions(false);
            } else {
              var opt = document.createElement('option');
              opt.value = result.data.id;
              opt.textContent = result.data.label;
              opt.selected = true;
              currentSelectEl.appendChild(opt);
            }
            dialog.close();
            currentSelectEl.dispatchEvent(new Event('change', { bubbles: true }));
            currentSelectEl = null;
          } else {
            errorsEl.textContent = (result.data.errors || []).join(', ');
            errorsEl.style.display = 'block';
          }
        })
        .catch(function(err) {
          errorsEl.textContent = 'An error occurred. Please try again.';
          errorsEl.style.display = 'block';
          console.warn('[LcpRuby] Inline create failed:', err);
        });
      });
    })();
  </script>
</body>
</html>
